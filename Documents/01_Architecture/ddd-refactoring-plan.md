# Eede アプリケーションのDDD的再設計分析と計画 (最終改訂版)

## 1. コンテキスト要約

### 1.1. 登場人物（アクター）
*   **ユーザー**: アプリケーションを操作してグラフィックを作成・編集する人。

### 1.2. 目的
*   ドット絵などのグラフィックを作成、編集、保存する。
*   直感的なUIで効率的に作業を進める。

### 1.3. 主要な機能
*   **描画**: フリーハンド、直線、塗りつぶしなどのツールでキャンバスに描画する。
*   **ファイル操作**: 新規画像の作成、既存画像の読み込み、編集中の画像の保存。
*   **色管理**: ペン色の選択、パレットへの色の保存・読み込み、背景色の設定。
*   **編集支援**: Undo/Redo、範囲選択、画像の反転・回転などの加工。
*   **ビュー操作**: 表示倍率の変更。
*   **ウィンドウ管理**: 複数の画像をタブで開き、編集する。

---

## 2. イベントストーミング一覧

| コマンド (Command)               | ドメインイベント (Domain Event)          | アクター (Actor) | 条件・ポリシー (Policy/Condition)            |
| :------------------------------- | :--------------------------------------- | :--------------- | :------------------------------------------- |
| **新しい画像を作成**             | `画像が新規作成された`                   | ユーザー         | サイズが指定されている                       |
| **画像ファイルを開く**           | `画像ファイルが読み込まれた`             | ユーザー         | サポートされている形式のファイルが選択された |
| **ファイルをドラッグ＆ドロップ** | `画像ファイルがドロップされた`           | ユーザー         | ドロップされたものがファイルである           |
| **描画ツールを選択**             | `描画ツールが変更された`                 | ユーザー         | -                                            |
| **ペンで描画を開始**             | `描画が開始された`                       | ユーザー         | キャンバス上でマウスが押された               |
| **ペンを動かす**                 | `描画が継続された`                       | ユーザー         | マウスが押されたまま移動した                 |
| **ペンを離す**                   | `描画が完了した`                         | ユーザー         | マウスが離された                             |
| **スポイトツールを使用**         | `色が選択された`                         | ユーザー         | キャンバス上で右クリックされた               |
| **パレットの色をクリック**       | `パレットから色が選択された`             | ユーザー         | -                                            |
| **パレットに色を登録**           | `色がパレットに登録された`               | ユーザー         | -                                            |
| **画像加工を実行**               | `画像が加工された` (反転/回転など)       | ユーザー         | -                                            |
| **元に戻す (Undo)**              | `操作が取り消された`                     | ユーザー         | Undo履歴が存在する                           |
| **やり直す (Redo)**              | `操作が復元された`                       | ユーザー         | Redo履歴が存在する                           |
| **画像を保存**                   | `画像が保存された`                       | ユーザー         | 保存先パスが指定された                       |
| **タブを閉じる**                 | `画像が閉じられようとしている`           | ユーザー         | -                                            |
| (Policy)                         | `保存が促された`                         | システム         | 画像が編集済みの場合                         |
| **保存を確認**                   | `画像が保存され、閉じられた`             | ユーザー         | -                                            |
| **破棄を確認**                   | `変更が破棄され、閉じられた`             | ユーザー         | -                                            |
| **ウィンドウを閉じる**           | `アプリケーションが終了しようとしている` | ユーザー         | -                                            |

---

## 3. ユビキタス言語候補一覧

*   **ImageCanvas**: 編集可能な画像そのもの。ピクセルデータ、操作履歴、編集状態を含むドメインの中心概念。
*   **Picture**: ピクセルデータの集合体（値オブジェクト）。
*   **Pen**: 描画に使う道具。色、太さ、スタイルを持つ。
*   **DrawTool**: 描画の種類（フリーハンド、直線、塗りつぶし）。
*   **Palette**: 色を保存しておく場所。
*   **History**: 操作の履歴（Undo/Redoのため）。

---

## 4. 境界づけられたコンテキスト案 (Bounded Contexts)

1.  **画像編集コンテキスト (ImageEditing Context)** 【コア】
    *   **責務**: ユーザーの描画や加工コマンドを受け取り、`ImageCanvas`の状態を一貫性を保ちながら変更する。
    *   **公開インターフェース**: 描画コマンド、加工コマンドの受付。`ImageCanvas`の変更を通知するドメインイベントの発行。

2.  **ファイル永続化コンテキスト (FilePersistence Context)** 【サポート】
    *   **責務**: `ImageCanvas`と物理ファイルとの間の変換（保存・読み込み）を行う。
    *   **公開インターフェース**: `IImageCanvasRepository` (Save, Loadメソッド)。

3.  **UIコンテキスト (UI Context)** 【ホスト/プレゼンテーション】
    *   **責務**: ユーザーからの入力を受け付け、ドメインイベントを購読して画面を更新する。

---

## 5. 各コンテキスト内の集約モデル図

### 画像編集コンテキスト (ImageEditing Context)

```
┌──────────────────────────┐
│ Aggregate: ImageCanvas     │
├──────────────────────────┤
│ - Id (Identifier)        │
│ - Picture (Value Object) │
│ - History (Value Object) │
│ - IsDirty (Flag)         │
│ - SourceFile (Value Object)│
├──────────────────────────┤
│ + UpdatePicture(newPic)  │
│ + ApplyEffect(...)       │
│ + Undo()                 │
│ + Redo()                 │
│ + MarkAsSaved(file)      │
└──────────────────────────┘
```


---

### **Eedeプロジェクトにおける具体的な適用例 (2025/11/01追記)**

DDDリファクタリングに伴い導入される新しいクラス群は、以下のネームスペースに配置することを決定する。

- **背景**:
  - `ImageCanvas`集約は、「画像編集」という明確なビジネス上の活動（アクティビティ）を表現する。
  - これはDDDにおける「境界づけられたコンテキスト」の考え方に合致する。
- **決定事項**:
  - **集約・エンティティ・値オブジェクト**: `Eede.Domain.ImageEditing`
    - 例: `Eede.Domain.ImageEditing.ImageCanvas`
  - **リポジトリインターフェース**: `Eede.Domain.ImageEditing`
    - 例: `Eede.Domain.ImageEditing.IImageCanvasRepository`
  - **リポジトリ実装**: `Eede.Infrastructure.Repositories`
    - 例: `Eede.Infrastructure.Repositories.ImageCanvasRepository`

---

## 6. 再設計後のDDDモデル概要

再設計後は、`MainViewModel`が担っていた多くのドメインロジックが、新設された**画像編集コンテキスト**内の`ImageCanvas`集約に移譲される。`DockPictureViewModel`は`ImageCanvas`のリードモデルとして機能し、`Eede.Presentation.Views.DataDisplay.PictureDocument`は純粋なViewコンポーネントとしての役割を担う。ViewModel間の連携は、`ImageCanvas`が発行するドメインイベントを介した疎結合なモデルに移行する。

---

## 7. テスト駆動開発(TDD)を取り入れた段階的リファクタリング計画

### フェーズ1：ドメインモデルの導入と並存

*   **ステップ1.1: `ImageCanvas`エンティティの作成（状態のみ）**
    *   **内容**: `Eede.Domain`に`ImageCanvas`クラスを作成し、状態を保持するプロパティのみを定義する。
    *   **テスト計画**:
        1.  **[Red]** `ImageCanvas`を初期化し、期待される初期状態（例: `IsDirty`が`false`）であることを検証する、失敗するユニットテストを書く。
        2.  **[Green]** テストが通るように`ImageCanvas`のコンストラクタとプロパティを実装する。

*   **ステップ1.2: `DockPictureViewModel`に`ImageCanvas`を導入し、状態を同期**
    *   **内容**: `DockPictureViewModel`に`ImageCanvas`プロパティを追加し、既存プロパティと`ImageCanvas`の状態が常に同期するように実装する。**この時点では既存プロパティは削除しない。**
    *   **テスト計画**:
        1.  **[Red]** `DockPictureViewModel`のプロパティ（例: `Edited`）を変更した際に、`ImageCanvas.IsDirty`も追随して変更されることを検証する、失敗する結合テストを書く。
        2.  **[Green]** テストが通るように`DockPictureViewModel`に同期ロジックを実装する。

### フェーズ2：ロジックの段階的移譲

*   **ステップ2.1: Undo/Redoの振る舞いを`ImageCanvas`に実装**
    *   **内容**: `ImageCanvas`に`Undo()`と`Redo()`メソッドを実装する。
    *   **テスト計画**:
        1.  **[Red]** `ImageCanvas`に操作履歴を追加した後、`Undo()`を呼び出すと`Picture`が前の状態に戻ることを検証する、失敗するユニットテストを書く。
        2.  **[Green]** テストが通るように`ImageCanvas.Undo()`を実装する。（`Redo`も同様）

*   **ステップ2.2: 描画・加工の振る舞いを`ImageCanvas`に実装**
    *   **内容**: `ImageCanvas`に`UpdatePicture(...)`等のメソッドを実装する。
    *   **テスト計画**:
        1.  **[Red]** `ImageCanvas`の`UpdatePicture`メソッドを呼び出すと、`Picture`が更新され、かつ`History`に操作が記録されることを検証する、失敗するユニットテストを書く。
        2.  **[Green]** テストが通るように`ImageCanvas.UpdatePicture`を実装する。

*   **ステップ2.3: ViewModelから`ImageCanvas`のメソッドを呼び出し（並行実行）**
    *   **内容**: `MainViewModel`の既存ロジックを消さずに、対応する`ImageCanvas`のメソッドを追加で呼び出す。
    *   **テスト計画**:
        1.  **[安全網]** 既存のViewModelの振る舞いを保証するテストがパスすることを確認する。
        2.  **[リファクタリング]** `MainViewModel`のコードを変更し、`ImageCanvas`のメソッド呼び出しを追加する。
        3.  **[確認]** 再度テストを実行し、すべてパスすることを確認する（振る舞いが破壊されていないことを保証）。

### フェーズ3：古い実装のクリーンアップ

*   **ステップ3.1: 古いUndo/Redoロジックの削除**
    *   **内容**: `MainViewModel`から古い`UndoSystem`を直接操作するコードと、`UndoSystem`プロパティ自体を削除する。
    *   **テスト計画**:
        1.  **[安全網]** `ImageCanvas`のユニットテストと、ViewModelの結合テストがすべてパスしていることを確認する。
        2.  **[リファクタリング]** `MainViewModel`から古いコードを削除する。
        3.  **[確認]** 再度すべてのテストを実行し、パスすることを確認する。

*   **ステップ3.2: 古い描画履歴ロジックの削除**
    *   **内容**: `MainViewModel`のイベントハンドラから古い`UndoSystem.Add()`の呼び出しを削除する。
    *   **テスト計画**: ステップ3.1と同様の安全網のもとでリファクタリングを行う。

*   **ステップ3.3: ViewModelの古い状態プロパティを削除**
    *   **内容**: `DockPictureViewModel`から並存させていた古いプロパティ（`PictureBuffer`, `Edited`等）を削除する。
    *   **テスト計画**: ステップ3.1と同様の安全網のもとでリファクタリングを行う。
