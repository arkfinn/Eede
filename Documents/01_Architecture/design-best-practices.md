# Eede 設計ベストプラクティス

### ドメイン駆動開発（DDD）と 振る舞い駆動開発（BDD）

## 1. ドメインの理解と戦略的モデリング

- **ドメインエキスパートとの協働:**
  ドメインエキスパート（業務担当者、顧客など）とのワークショップ（たとえば【イベントストーミング】など）を通して、ビジネス上の重要な概念、ルール、プロセスを抽出します。

- **バウンデッドコンテキストの定義:**
  システム全体を複数のサブドメインやバウンデッドコンテキストに分割し、各コンテキストでの責務や用語（ユビキタス言語）を明確にします。


## 2. ユーザーストーリーの作成（DDDの観点から）

- **ビジネス価値を軸に:**
  ユーザー視点で「誰が、何を、なぜ」実現したいかを記述します。たとえば
  > 「カスタマー**として**、注文履歴を確認 **したい**。**なぜなら** 購入状況を把握するため」
  といった形式で記述し、ドメイン固有の用語を用いることで、バウンデッドコンテキスト内の一貫した言語を確立します。

- **ユーザーストーリーの抽象度:**
  ユーザーストーリーはビジネス機能を表現する高レベルな要求となりますが、これを基に後述のBDDシナリオで具体的な振る舞いを定義します。


## 3. BDDシナリオの作成

- **受け入れ基準の明確化:**
  各ユーザーストーリーに対し、具体的な【Given-When-Then】形式のシナリオを作成します。

Given（前提条件）-When（アクション）-Then（結果）の記述
1. Given: 特定の前提条件が整っている状態
2. When: ユーザーが特定のアクションを実行する
3. Then: 期待される結果が発生する

  例:
  - **Given:** ユーザーがログインしており、注文履歴ページを開いている
  - **When:** 最新の注文が存在する場合
  - **Then:** 最新の注文が画面上部に表示される

- **ドメインの振る舞いの定義:**
  シナリオ内で、ドメインモデル（たとえば、集約、エンティティ、ドメインイベントなど）がどのように振る舞うべきかを記述し、実装すべきビジネスルールや制約を明確にします。

- **自動テストとしての利用:**
  作成したBDDシナリオは自動テストツール（例：Cucumber、SpecFlowなど）で実行できるようにして、実装が意図した振る舞いを担保するための「生きた仕様」として運用します。


### 振る舞いの設計方法

1.  **ユーザーの視点から記述する:** システムがどのように振る舞うべきかを、ユーザーの視点から記述します。
2.  **具体的なシナリオを使用する:** 具体的なシナリオを使用し、「Given-When-Then」の形式で記述します。
3.  **関係者と協力する:** 関係者と協力して、振る舞いを明確にします。
4.  **自動化されたテストで検証する:** 振る舞いを自動化されたテストで検証します。


## 4. ユーザーストーリーとBDDシナリオの連携

- **双方向のリンク付け:**
  - ユーザーストーリーは高レベルのビジネス要求を表し、
  - BDDシナリオはその要求が満たされる具体的な条件（振る舞い）を記述します。
  これにより、実装時に「なぜこの機能が必要か」「どのように振る舞うべきか」を明確に保てます。

- **ユビキタス言語の徹底:**
  ユーザーストーリー、BDDシナリオ、そして実際のドメインモデル（集約、エンティティなど）はすべて同一の用語や概念を用いることで、チーム間の認識ズレを防ぎます。


## 5. ドメインモデルの設計と実装

- **集約の設計:**
  ユーザーストーリーやBDDシナリオで示された業務の振る舞いや制約を元に、集約（Aggregate）を定義します。各集約は一貫性境界として、関連するビジネスルールを内包します。

- **ドメインサービス・ファクトリの活用:**
  単一のエンティティに収まりきらないロジックは、ドメインサービスとして切り出すなど、責務を明確に分離します。

- **振る舞いの実装:**
  BDDシナリオで定義した【When～Then】の部分に対応する処理を、集約のメソッドやドメインサービス内に実装します。たとえば、「注文履歴の最新表示」は、注文集約が持つ「最新注文を返す」メソッドとして実装され、BDDテストでその振る舞いを検証します。

- **TDD/BDDを活用した実装サイクル:**
  まずBDDシナリオ（テスト）を実装し、それに合わせたコードを書き、テストをパスさせるというサイクルを繰り返すことで、ドメインモデルとシナリオが整合する実装を進めます。


## 6. 継続的なフィードバックとリファクタリング

- **テストの実行とレビュー:**
  自動化されたBDDシナリオを常に実行し、要求の変化やドメイン理解の深化に応じて、ユーザーストーリー・BDDシナリオ・ドメインモデルを更新します。

- **リファクタリング:**
  ドメイン知識が深まる中で、集約の境界や責務が明確になるため、コードやモデルのリファクタリングを継続的に行います。BDDテストがあることで、安心して設計の改善ができます。
