# Shared Kernel 適用ガイドライン

## 1. はじめに

このドキュメントは、Eedeプロジェクトにおいてドメイン駆動設計（DDD）の戦略的設計パターンである **Shared Kernel（共有カーネル）** を適用する際の指針を定めるものです。

Shared Kernelは、コードの再利用性を高める強力なパターンである一方、誤用すると境界づけられたコンテキストの独立性を損ない、システム全体の保守性を著しく低下させる危険性があります。このガイドラインは、Shared Kernelがアンチパターンとなることを防ぎ、そのメリットを最大限に享受することを目的とします。

## 2. Shared Kernelとは

Shared Kernelとは、複数の境界づけられたコンテキストにまたがって、**完全に同一の概念とライフサイクルを持つ、ドメインモデルのごく一部**を共有するための専用ライブラリ（またはフォルダ）です。

これは「共通の便利クラス置き場」では**断じてありません**。

## 3. Shared Kernelがアンチパターンとなるケース（原則禁止事項）

以下のような動機でShared Kernelを使用することは、コンテキスト間の密結合を助長するため、原則として禁止します。

- **安易な共通化**: 「似ているから」という理由だけで、異なるコンテキストのモデルを共通化しようとすること。
- **「ゴミ捨て場」としての利用**: どこに配置すべきか分からないユーティリティクラスやヘルパークラスをとりあえず配置すること。
- **コンテキスト間の妥協**: 各コンテキストで微妙に意味合いが異なるモデルを、無理やり一つのクラスに統合すること。

これらの誤用は、境界づ-けられたコンテキストの最も重要な原則である「境界」を破壊し、チームの自律的な開発を妨げます。

## 4. Shared Kernelの適用を許可する条件

Shared Kernelに新しいコードを追加する際は、以下の**すべての条件**を満たしているか、厳格なレビューを行う必要があります。

1.  **真に普遍的であること**:
    - 共有する概念（主に値オブジェクト）が、どのコンテキストから見ても**意味や構造が完全に同一**であること。
    - 例: `Position(x, y)`, `Size(width, height)`, `Money(amount, currency)`

2.  **安定的であること**:
    - 共有する概念が、将来にわたって変更される可能性が極めて低いこと。
    - 一つのコンテキストの要求によって、他のコンテキストに影響を与えるような変更が発生してはなりません。

3.  **ドメインモデルの一部であること**:
    - 共有するのは、単なるデータ構造やユーティリティではなく、ユビキタス言語として定義されたドメインモデルの一部でなければなりません。

4.  **厳格なガバナンスプロセスを経ること**:
    - Shared Kernelへの変更は、それに依存する**すべてのチーム（コンテキスト担当者）の合意**を必要とします。
    - 変更要求はプルリクエスト等で通知され、すべての関係者によるレビューと承認を経てからマージされます。

## 5. 判断に迷った場合の原則

**「共有するより、重複させる（Don't Repeat Yourself原則の例外）」**

Shared Kernelに追加すべきか少しでも迷いが生じた場合は、共有を見送り、各コンテキスト内に同じ（あるいは似た）コードを個別に実装してください。

一見、コードの重複は悪に見えますが、それによって**各コンテキストの独立性と自律性が保たれる**メリットは、重複によるデメリットをはるかに上回ります。将来的に真の共有候補であることが判明した時点で、リファクタリングしてShared Kernelに移動させれば良いのです。

## 6. Eedeプロジェクトでの具体例

- **許可される例**:
  - `Eede.Domain.SharedKernel.Positions`
  - `Eede.Domain.SharedKernel.Sizes`
  - これらは普遍的かつ安定的な値オブジェクトであり、上記の条件を満たします。

- **禁止される例**:
  - `Eede.Domain.SharedKernel.Utils` のような曖昧なフォルダの作成。
  - `ImageEditing`コンテキストと`AnimationEditing`コンテキストで振る舞いが異なる可能性のある`Frame`のようなモデルを安易に共有すること。
