# DDD・BDDに基づくオニオンアーキテクチャ リファクタリングガイド

## 1. はじめに
このガイドは、DDD、BDD、オニオンアーキテクチャに基づき、既存システムをリファクタリングするためのものです。

## 2. 基本原則と設計思想
### 2.1 ドメイン駆動設計（DDD）の視点
- **ドメインモデリング**
  - ビジネスルールやドメイン知識に基づき、エンティティ、バリューオブジェクト、集約などを定義する
  - **※重要：** ドメイン層の各クラスはイミュータブルとして設計し、内部状態の変更が必要な場合は新たなインスタンスを生成する
- **振る舞いの集約**
  - 各ドメインクラスは、その責務に沿った振る舞い（メソッド）を持ち、ビジネスロジックを内部に集約する
  - ドメインサービスは極力排除し、ビジネスロジックは各エンティティやバリューオブジェクトに閉じ込める
- **ユビキタス言語の採用**
  - クラス名、メソッド名、変数名などはビジネス側の言語と一致させ、チーム内での認識統一を図る

### 2.2 振る舞い駆動開発（BDD）の視点
- **シナリオベースのテスト仕様**
  - ユーザーストーリーや具体的なビジネスシナリオを元に、期待する振る舞いを Given-When-Then 形式のテストケースとして記述する
- **テストファーストのアプローチ**
  - リファクタリング前後で同一のBDDテストを実装し、ビジネス振る舞いが変更されていないことを担保する

### 2.3 オニオンアーキテクチャの視点
- **レイヤー分離**
  - **内側：** ドメイン層（エンティティ、バリューオブジェクト – すべてイミュータブル）
  - **中間：** アプリケーション層（ユースケース実現のためのサービス）
    - **ユースケースクラスは1クラス1パブリックメソッド**とし、単一責任を徹底する
  - **外側：** インフラ層（永続化、外部システム連携）およびプレゼンテーション層（UIの表示処理）
- **依存関係逆転の原則**
  - 内側のドメイン層は外側の実装（インフラ、UIなど）に依存せず、抽象（インターフェース）にのみ依存する

## 3. リファクタリングのステップ
### ステップ1: 現状分析と問題点の洗い出し
- 既存システムのコードベースを分析し、ビジネスロジックが散在している箇所や技術依存が強い箇所を特定する
- BDDの観点で、現状の振る舞い（テストケース、ユースケース）を整理し再現性を確認する

### ステップ2: ドメインの抽出とモデリング
- ビジネスルールに基づき、ドメインの主要な概念を抽出する（例：注文、顧客、在庫など）
- 各概念をエンティティまたはバリューオブジェクトとして定義し、**イミュータブルな設計**を徹底する
  - 例：状態変更が必要な場合は、新規インスタンスを生成する設計にする

### ステップ3: アプリケーション層の整理とユースケースの実装
- 各ユースケースを実現するアプリケーションサービスを定義する
  - **原則：** ユースケースクラスは「1クラス1パブリックメソッド」の設計とし、メソッド内でドメイン層の振る舞いを組み立てる
- 外部とのやり取り（入力値のバリデーション、DTO変換など）はこの層で実施し、ドメイン層へは正しい形のデータのみを渡す

### ステップ4: インフラ層の分離
- 永続化、外部API連携、その他技術的実装は、インターフェース（ポート）を定義し、実装クラスとして分離する
- ドメイン層はこれらの具体的実装ではなく抽象インターフェースに依存する

### ステップ5: プレゼンテーション層の設計
- **画面表示はプレゼンテーション層で実施**する
  - ユーザーインターフェース（Web、モバイル、CLI等）の処理はここで行い、UI専用のコンポーネント（コントローラー、ビュー、テンプレート等）を整備する
- アプリケーション層からの出力はプレゼンテーション層で受け取り、適切なフォーマット（HTML、JSON等）に変換する

### ステップ6: BDDテストによる振る舞いの担保
- 抽出したシナリオに沿ってBDDテストを作成し、リファクタリング前後で同一のテストがパスすることを確認する
- テストケースをリファクタリングの安全装置として活用する

### ステップ7: 徐々にリファクタリングを実施
- 小さな単位で変更を加え、BDDテストで回帰を確認しながらリファクタリングを進める
- チーム内でリファクタリングのルールや進捗、ドメイン知識を共有し、ドキュメント化する

## 4. 推奨プラクティスと留意点
- **テスト自動化の徹底**
  BDDテストをCI/CDパイプラインに組み込み、リファクタリング時の回帰防止を確実にする
- **コードレビューとペアプログラミング**
  ドメインモデリングやユースケース実装の品質向上のため、レビューや共同作業を積極的に取り入れる
- **継続的なリファクタリング**
  コードの健全性を保つために、定期的なリファクタリングを習慣化する
- **ドメイン知識の共有**
  ユビキタス言語の浸透と、ビジネス側との密なコミュニケーションを重視する

## 5. 今後の調整ポイント
- **各層の詳細設計**
  アプリケーション層やインフラ層の具体的な実装方法は、プロジェクト要件に応じて後日詳細化する
- **テスト戦略の拡充**
  BDDテストのカバレッジやシナリオの充実を検討し、より複雑なケースに対応する
- **運用時の監視・ロギング**
  リファクタリング後のパフォーマンスや障害検知のため、監視システムやロギングの仕組みを整備する

## 6. まとめ
このガイドは、DDD、BDD、オニオンアーキテクチャに基づき、既存システムのリファクタリングを実践するためのものです。
- ドメイン層はイミュータブルクラスとする
- ユースケースクラスは1クラス1パブリックメソッドの原則に従う
- 画面表示はプレゼンテーション層で完結させる

各プロジェクトやチームの実情に合わせて、このガイドラインを調整し実践してください。
