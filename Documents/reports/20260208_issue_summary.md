# 不具合調査・対策検討レポート (2026-02-08)

## 1. 現在発生している不具合

### A. 選択枠・カーソル表示の不整合
- **現象**: 貼り付け直後に選択枠（枠とハンドル）が表示されない。マウスカーソルをキャンバス内の「画像がある領域」に移動させると初めて枠が出る。

### B. 操作の継続性
- **現象**:
  1. 選択範囲を一度移動させることはできる（正常）
  2. 一度マウスを離すと、二回目の移動（ドラッグ）が開始できない。（異常）
  3. 選択範囲を確定し、再度範囲選択を行うと移動できる（正常）

## 2. 実施済みの修正と結果 (未解決)

| 修正項目                                        | 意図                                                  | 結果                                     |
| :---------------------------------------------- | :---------------------------------------------------- | :--------------------------------------- |
| `Magnification.Minify` の Floor 化              | 負の座標（キャンバス外）の丸め誤差を修正              | 解決せず。内外判定の逆転が継続。         |
| `InteractionCoordinator` 座標変換の統一         | `Minify` を使用した表示座標からキャンバス座標への変換 | 継続的な移動が依然として不可。           |
| `SelectionPreviewInfo` への `SourcePixels` 追加 | リサイズ・移動の繰り返しによる劣化防止と判定安定化    | 判定が依然として不安定。                 |
| `DrawingSession` 履歴への `PreviewContent` 追加 | Undo 時の状態復元                                     | ユーザー期待値（確定単位の取消）と乖離。 |

## 3. 次の対策に向けた検討課題

### 座標変換の再検証
- `View` (Avalonia) から渡される座標が、実際にどのタイミングで「スケーリング済み」になり、どこで「論理ピクセル」として扱うべきか、境界線を再定義する必要がある。
- キャンバスの `Offset`（スクロール位置）が Coordinator 側に正しく伝わっていない、あるいは二重に適用されている可能性。

### 状態マシンの遷移条件
- `SelectionPreviewState` において、`Contains` 判定に使用している座標系が、ドラッグ終了後の `Position` 更新と同期しているか。
- `PointerBegin` 時の `EnsureInteractionSession` が、既存の状態を壊していないか。

### 履歴管理方針の再定義
- 「プレビュー状態」は履歴（UndoStack）に積まず、画像がキャンバスに焼き込まれた（Commit された）タイミングでのみ履歴を生成する方式へ戻す、あるいは調整する。
- Undo 時は「一つ前の確定状態（画像データ）」に戻ることを最優先とする。

## 4. 確認すべき項目
- `DrawableCanvas.axaml` における `canvas` のレイアウト（Margin/Padding/Alignment）が座標取得に与える影響。
- `DrawingSession` における `CommitPreview` 時の `UndoStack` への積み方。
- 貼り付け実行時 (`PasteAsync`) に生成される初期座標の計算ロジック。
