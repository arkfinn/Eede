# Track Specification: 範囲選択ツールのドラッグ移動後におけるアンドゥ時の不整合修正

## 1. 概要
範囲選択ツールで画像を移動させた後、アンドゥ（Undo）操作を行っても選択範囲の枠（点線）が移動前の位置に戻らない不具合を修正します。DrawingSession の履歴管理に選択範囲のメタデータを追加することで解決します。

## 2. 背景・目的
- 現状、DrawingSession の Undo/Redo スタックには Picture（画像データ）のみが保存されており、選択範囲の情報が欠落している。
- そのため、画像データが元に戻っても、UI上の選択枠は最後に操作した位置に取り残されてしまう。
- ユーザーが「移動操作をやり直す」際の直感的な挙動（画像も枠も戻る）を実現し、操作性を向上させる。

## 3. ゴール (Acceptance Criteria)
- [ ] DrawingSession が画像データと合わせて「選択範囲（PictureArea?）」を履歴として保持・復元できる。
- [ ] 範囲選択ツールの移動後にアンドゥを行うと、画像が移動前に戻り、かつ選択枠も移動前の位置に復帰する。
- [ ] リドゥ（Redo）操作時も、移動後の画像と選択枠が正しく再現される。
- [ ] 範囲選択以外のツール（ペン等）を使用している場合のアンドゥ挙動に悪影響を与えない。

## 4. 機能要件
### 4.1. ドメイン層の拡張 (DrawingSession)
- DrawingSession 内の UndoStack / RedoStack に保存するデータ型を、Picture 単体から「Picture と PictureArea? のペア」に変更する。
- Push, Undo, Redo メソッドにおいて、このペアを適切に処理するように修正する。

### 4.2. アプリケーション層の連携
- IDrawingSessionProvider を通じて、新しいセッション状態（画像 + 選択範囲）が各 ViewModel へ通知されるようにする。

### 4.3. プレゼンテーション層の同期
- DrawableCanvasViewModel がセッション変更（SessionChanged）を受け取った際、セッションに含まれる PictureArea の情報を自身の SelectingArea プロパティに反映させる。

## 5. 非機能要件
- **整合性:** メモリ使用量の極端な増加を避け、不変（Immutable）なデータ構造を維持する。
- **堅牢性:** 選択範囲がない場合（null）のハンドリングを適切に行う。

## 6. アウトオブスコープ
- 範囲選択ツールの移動アルゴリズム自体の変更。
- 「浮遊選択状態（Floating Selection）」の永続化。
