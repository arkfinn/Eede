# 仕様書: ドックへの画像転送(Pull)をアンドゥ履歴に含める

## 1. 概要
現在、作業エリアからドックへの画像転送（Pull操作）を行うと、ドック内の画像が直接更新され、アンドゥ（元に戻す）履歴に記録されません。
本トラックでは、この「Pull」操作をアプリケーション全体のアンドゥ/リドゥ履歴に統合し、ユーザーが誤って転送した場合でも元に戻せるようにします。

## 2. 目標
- **Pullのアンドゥ化:** 「Pull」操作を実行した際、その変更をアンドゥ/リドゥ可能にする。
- **履歴の一元管理:** 作業エリアでの描画とドックへの転送を、時系列順の単一の履歴として管理する。
- **影響範囲の限定:** Pull操作のアンドゥ実行時は、**ドック内の画像のみ**を転送前の状態に戻す。作業エリア（キャンバス）の状態は変更しない。

## 3. 機能要件
- **Pull実行時:**
    - 変更対象となるドック画像の「更新前の状態」を保持する。
    - メモリ効率のため、画像全体ではなく**変更範囲（差分）のみ**を保持することを基本とする。
    - アンドゥスタックに新しい操作履歴を追加する。
- **Undo実行時 (Pull操作に対して):**
    - 対象のドック画像を、Pull実行前の状態に戻す。
    - 作業エリア（キャンバス）の画像や選択範囲には**一切変更を加えない**。
- **Redo実行時 (Pull操作に対して):**
    - 対象のドック画像を、再度Pull実行後の状態に更新する。

## 4. アーキテクチャ上の考慮事項
- **DrawingSessionの拡張:** 現在の `DrawingSession` は主に作業エリアの `Picture` 状態を管理しています。これを拡張し、「ドック画像の更新」という異なる種類の操作も扱えるようにする必要があります。
    - `IHistoryItem` 等によるポリモーフィックな履歴管理を導入します。
    - `CanvasHistoryItem`: 作業エリア用
    - `DockUpdateHistoryItem`: ドック更新用（ID, 位置, 差分画像）

## 5. 受け入れ基準
- [ ] 「Pull」を実行するとドックの画像が更新され、かつ「元に戻す」ボタンが有効になる。
- [ ] 「Pull」直後に「元に戻す」を実行すると、ドックの画像が転送前の状態に戻る。
- [ ] 「Pull」の「元に戻す」実行時、作業エリアの画像は変化しない。
- [ ] 「やり直し（Redo）」を実行すると、再びドックの画像が更新される。
- [ ] 通常の描画操作のアンドゥ/リドゥも、これまで通り正常に機能する。
