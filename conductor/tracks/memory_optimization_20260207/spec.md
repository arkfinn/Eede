# 軌跡仕様書: 巨大画像対応のためのメモリ最適化と差分Undo

## 1. 概要
4096x4096pxを超えるような巨大な画像を扱う際のメモリ消費を削減し、パフォーマンスを向上させる。具体的には、UI層でのビットマップ管理の厳格化、GPUスケーリングによる拡大画像生成の廃止、および履歴（Undo/Redo）の差分管理（変更された矩形領域のみ保存）を導入する。

## 2. 機能要件
- **ビットマップリソース管理の徹底:**
  - `ViewModel` が保持する `Bitmap` プロパティにおいて、新しい画像の代入時に古いインスタンスを確実に `Dispose()` する。
  - これは `MainViewModel` (作業エリア) と `DockPictureViewModel` (ドックエリア) の両方に適用する。
- **GPUスケーリングへの移行:**
  - ドメイン層で拡大された `Picture` を生成する処理を廃止する。
  - 作業エリアおよびドックエリアの View (`DrawableCanvas`, `PictureContainer`) にて、`Stretch="Fill"` または `Stretch="Uniform"` を活用し、等倍のビットマップをGPU側で拡大表示する構造へ変更する。
  - 拡大時は `RenderOptions.BitmapInterpolationMode="None"` (ニアレストネイバー) を維持する。
- **差分Undoの実装:**
  - 履歴 (`IHistoryItem`) の構造を拡張し、従来の「全ピクセル保存 (`FullPictureHistory`)」に加え、「差分保存 (`DiffPictureHistory`)」をサポートする。
  - `DiffPictureHistory` は、変更があった最小矩形領域 (`PictureArea`) と、その領域の変更前後のピクセルデータのみを保持する。
- **ツールの差分報告:**
  - 各描画ツール（ペン、矩形、塗りつぶし等）のインターフェースを拡張し、描画実行後に「変更された範囲」を返却するように変更する。
  - まずは基本ツールから順次対応し、新旧の履歴形式が混在しても動作するようにする。

## 3. 非機能要件
- **互換性:** 既存のプロジェクトファイルや操作感に影響を与えないこと。
- **堅牢性:** `Dispose` 漏れによるメモリーリークが発生しないことを、プロファイリングまたはコードレビューで確認する。
- **段階的移行:** すべてのツールを一度に書き換えず、まずは履歴システムの基盤を整備し、主要ツールから順次移行する。

## 4. 受け入れ基準
- [ ] 巨大画像（例: 4096x4096px）を開き、拡大縮小を繰り返してもメモリ使用量が爆発的に増加しない。
- [ ] ペン等で描画した後、Undo/Redoが正常に動作し、かつその際のメモリ増加量が「画像全体サイズ」ではなく「描画範囲分」程度に抑えられている。
- [ ] ドックエリアの画像拡大時もメモリ効率が改善されている。
- [ ] 既存の全てのツールが正常に動作する（差分対応・未対応問わず）。

## 5. 範囲外 (Out of Scope)
- ゼロクローン変換（`ReadOnlySpan<byte>` 等を用いたネイティブ転送）の導入は、今回のスコープには含めない（将来の課題とする）。
- アニメーションの差分最適化（今回は静止画の編集操作に注力する）。
