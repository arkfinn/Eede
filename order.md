以下は一般的な観点から定義された選択範囲の移動機能です。
これを元に本プロジェクトに適した実装を検討してください。
---

# ペイントエディタ拡張：共通アニメーションエンジン実装指示書

## 1. 開発の概要

既存のマルチタブ形式ペイントエディタに、「スプライトアニメーション確認用モジュール」を実装してください。
このモジュールの最大の特徴は、**「アニメーションパターン（動きの定義）」と「画像（描画データ）」を分離**し、同一のパターンを別タブの画像に即座に適用してプレビューできる点にあります。

## 2. 実装すべき3つの主要コンポーネント

### A. グローバル設定パネル (Global Grid Config)

全タブ共通、またはプリセット保存可能なグリッド設定。

* **設定項目:** `cellWidth`, `cellHeight`, `offsetX`, `offsetY`, `padding`
* **機能:** メインキャンバス上にセル番号（0から始まるインデックス）を表示するオーバーレイの制御。

### B. アニメーション・ライブラリ & シーケンサー (Animation Library & Sequencer)

アニメーションの「型」を定義するエディタ。

* **データ構造:**
* `Pattern`: `{ id: string, name: string, frames: Frame[] }`
* `Frame`: `{ cellIndex: number, duration: number (ms) }`


* **UI仕様:**
* **パターンリスト:** 「待機」「走り」などの名称で複数のパターンを作成・保存可能。
* **シーケンサー:** 選択中パターンの `Frame` 配列を横並びに表示。
* **インタラクション:** キャンバス上のセルをクリック、またはドラッグ＆ドロップすることで、その `cellIndex` をシーケンサーの末尾に追加。
* **ウェイト編集:** 各フレームの下部に `duration` を変更できる入力フィールドを配置。



### C. リアルタイム・プレビュー (Floating Preview)

現在選択されている「タブの画像」と「ライブラリのパターン」を合成して表示。

* **表示ロジック:** `currentTab.image` から `activePattern.currentFrame.cellIndex` に基づく矩形領域を切り出して描画。
* **タブ連動:** ユーザーがエディタのタブを切り替えた際、プレビュー対象の画像は即座に切り替わるが、再生中のアニメーションパターンと再生位置（Time）は維持すること。
* **制御:** 再生/停止、ループON/OFF、再生倍率(0.5x~4x)。

## 3. 技術的要件・ステート設計

* **ステートの分離:**
* `ImageState`: 各タブが保持（ピクセルデータ）。
* `AnimationState`: アプリ全体で共有（パターンの配列、選択中のパターンID）。


* **描画更新タイミング:**
1. 編集中のタブでドットが打たれた時（Dirtyフラグ）。
2. アニメーションのフレームが進行した時。
3. シーケンサーの内容（セル番号や時間）が書き換えられた時。


* **座標計算式:**
* `cellX = (index % columns) * (cellWidth + padding) + offsetX`
* `cellY = Math.floor(index / columns) * (cellHeight + padding) + offsetY`



## 4. UI配置ガイド

* **右サイドバー上部:** グリッド設定およびアニメーションパターンの一覧（セレクトボックス/リスト）。
* **右サイドバー下部:** プレビューウィンドウ（チェッカーフラグ背景を推奨）。
* **画面下部（フッター領域）:** 横長のシーケンサー。フレームのサムネイルを表示できるのが理想。

## 5. 期待されるユーザー体験 (UX)

ユーザーが「キャラA」のタブで歩行アニメーションを作成した後、「キャラB」のタブをクリックするだけで、設定を一切いじることなく「キャラBが同じ歩行動作をしているプレビュー」を確認できること。

---
